import{g as se,r as F,c as b,aj as fe,ak as ue,al as ve,h as Q,A as ge,am as pe,an as be,ao as ye,ap as Ve,aq as Ce,ar as Fe,as as ae,at as he,au as xe,av as Se,o as we,k as le,l as q,m,f as r,Q as K,n as C,t as X,v as te,V as Y,x as N,a4 as oe,p as G,_ as D,ab as ie,S as H,y as B,ac as T}from"./index-DD84rciS.js";import{Q as _e}from"./QTd-Bq4iPcoX.js";import{Q as ke}from"./QTable-B6mhboVn.js";import{b as Ie,Q as ne}from"./QSelect-D9KbhcM8.js";import{Q as Ae,a as Ne}from"./QToolbar-CvcB6vS-.js";import{Q as Te}from"./QTooltip-D3K5a0T4.js";import{h as Qe}from"./format-DyQxkAtJ.js";import{Q as ze}from"./QPage-BB2Um8dJ.js";import{C as J}from"./ClosePopup-CT1KP1o0.js";import{api as E}from"./axios-DO-4OFiN.js";import{U as re}from"./Utils-DJ7xQ2GR.js";import"./QVirtualScroll-DljW3BAz.js";import"./QList-BWY4JASi.js";import"./QMarkupTable-DvZ2xV1r.js";import"./QItemLabel-Y1e7J-9n.js";function R(a,v,x,S){const s=[];return a.forEach(f=>{S(f)===!0?s.push(f):v.push({failedPropValidation:x,file:f})}),s}function $(a){a!=null&&a.dataTransfer&&(a.dataTransfer.dropEffect="copy"),ue(a)}const Oe={multiple:Boolean,accept:String,capture:String,maxFileSize:[Number,String],maxTotalSize:[Number,String],maxFiles:[Number,String],filter:Function},Ue=["rejected"];function De({editable:a,dnd:v,getFileInput:x,addFilesToQueue:S}){const{props:s,emit:f,proxy:h}=se(),w=F(null),y=b(()=>s.accept!==void 0?s.accept.split(",").map(l=>(l=l.trim(),l==="*"?"*/":(l.endsWith("/*")&&(l=l.slice(0,l.length-1)),l.toUpperCase()))):null),k=b(()=>parseInt(s.maxFiles,10)),c=b(()=>parseInt(s.maxTotalSize,10));function z(l){var t;if(a.value)if(l!==Object(l)&&(l={target:null}),((t=l.target)==null?void 0:t.matches('input[type="file"]'))===!0)l.clientX===0&&l.clientY===0&&fe(l);else{const e=x();e!==l.target&&(e==null||e.click(l))}}function O(l){a.value&&l&&S(null,l)}function A(l,t,e,i){let o=Array.from(t||l.target.files);const p=[],I=()=>{p.length!==0&&f("rejected",p)};if(s.accept!==void 0&&y.value.indexOf("*/")===-1&&(o=R(o,p,"accept",u=>y.value.some(g=>u.type.toUpperCase().startsWith(g)||u.name.toUpperCase().endsWith(g))),o.length===0))return I();if(s.maxFileSize!==void 0){const u=parseInt(s.maxFileSize,10);if(o=R(o,p,"max-file-size",g=>g.size<=u),o.length===0)return I()}if(s.multiple!==!0&&o.length!==0&&(o=[o[0]]),o.forEach(u=>{u.__key=u.webkitRelativePath+u.lastModified+u.name+u.size}),i===!0){const u=e.map(g=>g.__key);o=R(o,p,"duplicate",g=>u.includes(g.__key)===!1)}if(o.length===0)return I();if(s.maxTotalSize!==void 0){let u=i===!0?e.reduce((g,M)=>g+M.size,0):0;if(o=R(o,p,"max-total-size",g=>(u+=g.size,u<=c.value)),o.length===0)return I()}if(typeof s.filter=="function"){const u=s.filter(o);o=R(o,p,"filter",g=>u.includes(g))}if(s.maxFiles!==void 0){let u=i===!0?e.length:0;if(o=R(o,p,"max-files",()=>(u++,u<=k.value)),o.length===0)return I()}if(I(),o.length!==0)return o}function L(l){$(l),v.value!==!0&&(v.value=!0)}function d(l){ue(l),(l.relatedTarget!==null||ve.is.safari!==!0?l.relatedTarget!==w.value:document.elementsFromPoint(l.clientX,l.clientY).includes(w.value)===!1)===!0&&(v.value=!1)}function U(l){$(l);const t=l.dataTransfer.files;t.length!==0&&S(null,t),v.value=!1}function j(l){if(v.value===!0)return Q("div",{ref:w,class:`q-${l}__dnd absolute-full`,onDragenter:$,onDragover:$,onDragleave:d,onDrop:U})}return Object.assign(h,{pickFiles:z,addFiles:O}),{pickFiles:z,addFiles:O,onDragover:L,onDragleave:d,processFiles:A,getDndNode:j,maxFilesNumber:k,maxTotalSizeNumber:c}}const Re=ge({name:"QFile",inheritAttrs:!1,props:{...ye,...be,...Oe,modelValue:[File,FileList,Array],append:Boolean,useChips:Boolean,displayValue:[String,Number],tabindex:{type:[String,Number],default:0},counterLabel:Function,inputClass:[Array,String,Object],inputStyle:[Array,String,Object]},emits:[...pe,...Ue],setup(a,{slots:v,emit:x,attrs:S}){const{proxy:s}=se(),f=Ve(),h=F(null),w=F(!1),y=Ce(a),{pickFiles:k,onDragover:c,onDragleave:z,processFiles:O,getDndNode:A}=De({editable:f.editable,dnd:w,getFileInput:Z,addFilesToQueue:ee}),L=Fe(a),d=b(()=>Object(a.modelValue)===a.modelValue?"length"in a.modelValue?Array.from(a.modelValue):[a.modelValue]:[]),U=b(()=>ae(d.value)),j=b(()=>d.value.map(n=>n.name).join(", ")),l=b(()=>Qe(d.value.reduce((n,V)=>n+V.size,0))),t=b(()=>({totalSize:l.value,filesNumber:d.value.length,maxFiles:a.maxFiles})),e=b(()=>({tabindex:-1,type:"file",title:"",accept:a.accept,capture:a.capture,name:y.value,...S,id:f.targetUid.value,disabled:f.editable.value!==!0})),i=b(()=>"q-file q-field--auto-height"+(w.value===!0?" q-file--dnd":"")),o=b(()=>a.multiple===!0&&a.append===!0);function p(n){const V=d.value.slice();V.splice(n,1),u(V)}function I(n){const V=d.value.indexOf(n);V!==-1&&p(V)}function u(n){x("update:modelValue",a.multiple===!0?n:n[0])}function g(n){n.keyCode===13&&Se(n)}function M(n){(n.keyCode===13||n.keyCode===32)&&k(n)}function Z(){return h.value}function ee(n,V){const _=O(n,V,d.value,o.value),W=Z();W!=null&&(W.value=""),_!==void 0&&((a.multiple===!0?a.modelValue&&_.every(me=>d.value.includes(me)):a.modelValue===_[0])||u(o.value===!0?d.value.concat(_):_))}function P(){return[Q("input",{class:[a.inputClass,"q-file__filler"],style:a.inputStyle})]}function de(){if(v.file!==void 0)return d.value.length===0?P():d.value.map((V,_)=>v.file({index:_,file:V,ref:this}));if(v.selected!==void 0)return d.value.length===0?P():v.selected({files:d.value,ref:this});if(a.useChips===!0)return d.value.length===0?P():d.value.map((V,_)=>Q(Ie,{key:"file-"+_,removable:f.editable.value,dense:!0,textColor:a.color,tabindex:a.tabindex,onRemove:()=>{p(_)}},()=>Q("span",{class:"ellipsis",textContent:V.name})));const n=a.displayValue!==void 0?a.displayValue:j.value;return n.length!==0?[Q("div",{class:a.inputClass,style:a.inputStyle,textContent:n})]:P()}function ce(){const n={ref:h,...e.value,...L.value,class:"q-field__input fit absolute-full cursor-pointer",onChange:ee};return a.multiple===!0&&(n.multiple=!0),Q("input",n)}return Object.assign(f,{fieldClass:i,emitValue:u,hasValue:U,inputRef:h,innerValue:d,floatingLabel:b(()=>U.value===!0||ae(a.displayValue)),computedCounter:b(()=>{if(a.counterLabel!==void 0)return a.counterLabel(t.value);const n=a.maxFiles;return`${d.value.length}${n!==void 0?" / "+n:""} (${l.value})`}),getControlChild:()=>A("file"),getControl:()=>{const n={ref:f.targetRef,class:"q-field__native row items-center cursor-pointer",tabindex:a.tabindex};return f.editable.value===!0&&Object.assign(n,{onDragover:c,onDragleave:z,onKeydown:g,onKeyup:M}),Q("div",n,[ce()].concat(de()))}}),Object.assign(s,{removeAtIndex:p,removeFile:I,getNativeElement:()=>h.value}),he(s,"nativeEl",()=>h.value),xe(f)}}),Le={class:"row items-center justify-between q-mb-md"},je={key:0},qe={key:1},Pe={key:2},Be={class:"row q-col-gutter-md"},Ee={class:"text-body2 q-mb-md"},$e={class:"col-6"},Me={class:"col-6"},We={class:"col-12"},Ke={class:"col-12"},ua={__name:"OrdenValidacion",setup(a){const v=F(!1),x=F(""),S=F([]),s=F({}),f=F([]),h=F(!1),w=F(null),y=F(null),k=F(!1),c=F({Observaciones:"",Latitud:"",Longitud:"",Fotos:[],Resultado:""}),z=[{name:"Codigo",label:"Código",field:"CodigoRadicado",align:"center",sortable:!0},{name:"Fecha",label:"Fecha",field:"FechaRadicado",align:"center",format:t=>re.formatearFecha(t)},{name:"Creador",label:"Creador",field:"CreadorOrden",align:"center"},{name:"Barrio",label:"Barrio",field:"Barrio",align:"center"},{name:"NombreTecnico",label:"Asignado a",field:"NombreTecnico",align:"center"},{name:"acciones",label:"Acciones",align:"center"}],O=b(()=>{if(!x.value)return S.value;const t=x.value.toLowerCase();return S.value.filter(e=>{var i,o,p;return((i=e.CodigoRadicado)==null?void 0:i.toLowerCase().includes(t))||((o=e.Barrio)==null?void 0:o.toLowerCase().includes(t))||((p=e.AsignadoA)==null?void 0:p.toLowerCase().includes(t))})}),A=async()=>{v.value=!0;try{const t=await E.get(`/ordenservicio/${s.value.IdEmpresa}/2/traer-ordenes-empresa-visita`);S.value=t.data}catch{T.create({message:"Error al cargar órdenes",color:"negative",icon:"error"})}finally{v.value=!1}},L=async()=>{try{const t=await E.get(`usuario/2/${s.value.IdEmpresa}/usuario-por-cargo`);f.value=t.data}catch{T.create({message:"Error al cargar técnicos",color:"negative",icon:"error"})}},d=t=>{console.log(t),y.value=t,h.value=!0},U=async()=>{try{const t={IdPqrs:y.value.IdPqrs,IdUsuario:w.value.IdUsuario,IdUsuarioA:s.value.IdUsuario};await E.post("ordenservicio/asignar-tecnicos-orden-visita",t),T.create({message:"Técnico asignado correctamente",color:"positive",icon:"check"}),h.value=!1,A()}catch{T.create({message:"Error al asignar técnico",color:"negative",icon:"error"})}},j=t=>{y.value=t,k.value=!0},l=async()=>{if(!c.value.Resultado){T.create({message:"Debe seleccionar el resultado de la validación",color:"warning",icon:"warning"});return}const t=new FormData;t.append("IdOrden",y.value.IdOrden),t.append("Observaciones",c.value.Observaciones),t.append("Latitud",c.value.Latitud),t.append("Longitud",c.value.Longitud),t.append("Resultado",c.value.Resultado);for(let e of c.value.Fotos)t.append("Fotos",e);try{await E.post("/ordenservicio/guardar-validacion",t,{headers:{"Content-Type":"multipart/form-data"}}),T.create({message:"Validación guardada correctamente",color:"positive",icon:"check"}),k.value=!1,A()}catch{T.create({message:"Error al guardar validación",color:"negative",icon:"error"})}};return we(async()=>{const t=await re.datoUsuario();s.value=t,await A(),t.IdRol==1&&await L()}),(t,e)=>(q(),le(ze,{class:"q-pa-md bg-grey-1"},{default:m(()=>[r(K,{flat:"",bordered:"",class:"q-pa-md shadow-2"},{default:m(()=>[C("div",Le,[e[8]||(e[8]=C("div",{class:"text-h6"},"Órdenes en Fase de Validación",-1)),r(X,{dense:"",debounce:"300",modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=i=>x.value=i),placeholder:"Buscar orden...",filled:"",clearable:""},{append:m(()=>[r(te,{name:"search"})]),_:1},8,["modelValue"])]),r(ke,{rows:O.value,columns:z,"row-key":"IdOrden",loading:v.value,"no-data-label":"No hay órdenes para validar",flat:"",bordered:""},{"body-cell-acciones":m(i=>[r(_e,{align:"center"},{default:m(()=>[s.value.IdRol==1?(q(),Y("div",je,[r(N,{color:"black",label:"Asignar Técnico",icon:"person_add",size:"sm",onClick:o=>d(i.row)},null,8,["onClick"])])):s.value.IdRol==2&&i.row.NombreTecnico==s.value.NombreCompleto?(q(),Y("div",qe,[r(N,{color:"black",label:"Validar",icon:"build",size:"sm",onClick:o=>j(i.row)},null,8,["onClick"])])):(q(),Y("div",Pe,"-"))]),_:2},1024)]),_:1},8,["rows","loading"])]),_:1}),r(oe,{modelValue:h.value,"onUpdate:modelValue":e[2]||(e[2]=i=>h.value=i)},{default:m(()=>[r(K,{style:{"min-width":"400px"}},{default:m(()=>[r(G,{class:"text-h6"},{default:m(()=>[...e[9]||(e[9]=[D("Asignar Técnico",-1)])]),_:1}),r(G,null,{default:m(()=>[r(ne,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=i=>w.value=i),options:f.value,"option-label":"NombreCompleto","option-value":"IdUsuario",label:"Seleccione un técnico",filled:"",clearable:""},null,8,["modelValue","options"])]),_:1}),r(ie,{align:"right"},{default:m(()=>[H(r(N,{flat:"",label:"Cancelar",color:"grey"},null,512),[[J]]),r(N,{label:"Asignar",color:"primary",onClick:U})]),_:1})]),_:1})]),_:1},8,["modelValue"]),r(oe,{maximized:"","full-width":"",modelValue:k.value,"onUpdate:modelValue":e[7]||(e[7]=i=>k.value=i),persistent:""},{default:m(()=>[r(K,{style:{"min-width":"600px","max-width":"90vw"}},{default:m(()=>[r(Ae,{class:"bg-blue-grey-9 text-white"},{default:m(()=>[r(Ne,null,{default:m(()=>{var i;return[D(" Validar Orden - "+B((i=y.value)==null?void 0:i.CodigoRadicado),1)]}),_:1}),H((q(),le(N,{flat:"",icon:"close"},{default:m(()=>[r(Te,{"content-class":"bg-white text-primary"},{default:m(()=>[...e[10]||(e[10]=[D("Cerrar",-1)])]),_:1})]),_:1})),[[J]])]),_:1}),r(G,null,{default:m(()=>[C("div",Be,[C("div",Ee,[e[11]||(e[11]=C("strong",null,"Barrio:",-1)),D(" "+B(y.value.Barrio||"Sin información")+" ",1),e[12]||(e[12]=C("strong",null,"Direccion:",-1)),D(" "+B(y.value.Direccion||"Sin información")+" ",1),e[13]||(e[13]=C("strong",null,"Observacion:",-1)),D(" "+B(y.value.Observacion||"No especificada"),1),e[14]||(e[14]=C("br",null,null,-1))]),e[15]||(e[15]=C("div",{class:"col-12"},null,-1)),C("div",$e,[r(X,{modelValue:c.value.Latitud,"onUpdate:modelValue":e[3]||(e[3]=i=>c.value.Latitud=i),label:"Latitud",filled:""},null,8,["modelValue"])]),C("div",Me,[r(X,{modelValue:c.value.Longitud,"onUpdate:modelValue":e[4]||(e[4]=i=>c.value.Longitud=i),label:"Longitud",filled:""},null,8,["modelValue"])]),C("div",We,[r(Re,{modelValue:c.value.Fotos,"onUpdate:modelValue":e[5]||(e[5]=i=>c.value.Fotos=i),label:"Subir fotos del sitio",filled:"",multiple:"",accept:"image/*","use-chips":""},{append:m(()=>[r(te,{name:"photo_camera"})]),_:1},8,["modelValue"])]),C("div",Ke,[r(ne,{modelValue:c.value.Resultado,"onUpdate:modelValue":e[6]||(e[6]=i=>c.value.Resultado=i),options:[{label:"Sitio verificado y correcto",value:"Aprobado"},{label:"Se requiere ajuste o corrección",value:"Rechazado"}],label:"Resultado de validación",filled:""},null,8,["modelValue"])])])]),_:1}),r(ie,{align:"right"},{default:m(()=>[H(r(N,{flat:"",label:"Cancelar",color:"grey"},null,512),[[J]]),r(N,{label:"Guardar Validación",color:"positive",onClick:l})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{ua as default};
