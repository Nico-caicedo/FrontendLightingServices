import{r as t,o as ve,k as N,l as k,m as c,n as r,f as n,X as me,Q as x,x as p,y as T,a2 as fe,a4 as ge,S as W,_ as be,V as ye,t as we}from"./index-DD84rciS.js";import{Q as G}from"./QVirtualScroll-DljW3BAz.js";import{Q as he,a as _e}from"./QToolbar-CvcB6vS-.js";import{Q as D}from"./QSelect-D9KbhcM8.js";import{Q as Pe}from"./QPage-BB2Um8dJ.js";import{C as K}from"./ClosePopup-CT1KP1o0.js";import{api as V}from"./axios-DO-4OFiN.js";import{U as q}from"./Utils-DJ7xQ2GR.js";import{_ as Ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./QList-BWY4JASi.js";import"./QMarkupTable-DvZ2xV1r.js";import"./QItemLabel-Y1e7J-9n.js";import"./format-DyQxkAtJ.js";const Ie={class:"map-wrapper"},ke={class:"row items-center justify-between q-gutter-xs"},xe={class:"row items-center q-gutter-xs"},Ve={class:"row items-center q-gutter-xs"},qe={class:"text-subtitle2 q-mb-xs"},Se={class:"row items-center justify-between q-my-xs"},Oe={class:"ellipsis"},Me={class:"row q-col-gutter-md q-pa-md"},Ee={class:"col-12 col-md-8 column"},Be={key:0,class:"text-grey q-mt-md text-center"},Le={class:"text-body2 q-mb-xs"},Qe={class:"col-12 col-md-4 column"},Ne={class:"q-mt-md row justify-end q-gutter-sm"},Te={__name:"MapasPages",setup(De){const S=t(""),u=t(null),O=t([]),F=t(new Set),f=t([]),b=t(null),y=t(!1),i=t([]),P=t(!1),C=t(!1),X=t([]),M=t(null),Y=t([{label:"Pendiente por asignar",value:1},{label:"Asignado",value:2}]),E=t(1),B=t(""),w=t({}),L=t(null),d=t(!1),h=t(!1),Q=t(new Set),U=t(!1);let I=null;const $={lat:1.61438,lng:-75.60623},Z=t(!0);async function R(){return new Promise(o=>{if(window.google&&window.google.maps)o();else{const a=document.createElement("script");a.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKZ3VPgXSiG0COYvCfpNkAWMbT0KkBkRQ&libraries=geometry,drawing",a.async=!0,a.defer=!0,a.onload=o,document.head.appendChild(a)}})}function H(o){f.value.length&&(f.value.forEach(a=>a.setMap(null)),f.value=[]),o.forEach((a,e)=>{var v,m;const l=a.Coordenadas.split(" ").map(_=>{const[de,pe]=_.split(",").map(Number);return{lat:pe,lng:de}}),s=new google.maps.Polygon({paths:l,strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.05,map:null}),g=new google.maps.InfoWindow({content:`<b>${a.Nombre}</b>`});s.addListener("click",_=>{g.setPosition(_.latLng),g.open(u.value)}),s.idBarrio=((m=(v=a.IdBarrio)!=null?v:a.id)!=null?m:null)||e+1,f.value.push(s)})}async function J(o){try{return(await V.get(`ordenservicio/${S.value.IdEmpresa}/${o}/traer-postes-empresa`)).data}catch(a){return console.error("Error al cargar postes por barrio:",a),[]}}function ee(o){O.value.length;const a=o.map(e=>{if(!e.Coordenadas)return null;const[l,s]=e.Coordenadas.split(",").map(_=>_.trim()),g=parseFloat(l),v=parseFloat(s);if(isNaN(g)||isNaN(v))return null;const m=new google.maps.Marker({position:{lat:g,lng:v},map:u.value,title:e.Descripcion||"Poste sin descripción"});return m.data=e,m.addListener("click",()=>{new google.maps.InfoWindow({content:`<b>Coordenadas:</b> ${e.Coordenadas}<br><b>Descripción:</b> ${e.Descripcion||"Sin descripción"}`}).open(u.value,m)}),m}).filter(Boolean);O.value.push(...a)}async function z(){if(!u.value||U.value)return;const o=u.value.getBounds();if(o){h.value=!0;try{const e=f.value.map(s=>({polygon:s,id:s.idBarrio})).filter(({polygon:s})=>s.getPath().getArray().some(v=>o.contains(v))).map(s=>s.id).filter(s=>s&&!F.value.has(s)&&!Q.value.has(s));if(e.length===0)return;const l=e[0];Q.value.add(l);try{const s=await J(l);ee(s),F.value.add(l)}finally{Q.value.delete(l)}U.value=!0,I&&(google.maps.event.removeListener(I),I=null)}finally{h.value=!1}}}function ae(o){const a=new Set(i.value.map(e=>e.IdPoste||e.id));o.forEach(e=>{const l=e.IdPoste||e.id;l&&!a.has(l)&&i.value.push(e)})}function oe(o){const a=(o==null?void 0:o.IdPoste)||(o==null?void 0:o.id);a&&(i.value=i.value.filter(e=>(e.IdPoste||e.id)!==a),delete w.value[a])}function A(){i.value=[],w.value={}}function le(){P.value=!P.value,j()}function se(){C.value=!0}async function te(o){if(!(!o||!o.IdPoste))try{L.value=o.IdPoste;const a=await V.get(`luminarias/${o.IdPoste}`);o._luminarias=(a.data||[]).map(e=>({label:e.Nombre||e.id,value:e.IdLuminaria||e.id}))}catch{o._luminarias=[]}finally{L.value=null}}function ne(o){return(o==null?void 0:o._luminarias)||[]}async function re(){var o;try{d.value=!0;const a=i.value.map(l=>({IdPoste:l.IdPoste||l.id,IdLuminaria:w.value[l.IdPoste||l.id]||null})),e={IdEmpresa:(o=S.value)==null?void 0:o.IdEmpresa,Tecnico:M.value||null,Estado:E.value,Observaciones:B.value||"",Detalle:a};await V.post("ordenservicio/crear",e),C.value=!1,A(),q.notificacion("Orden creada",!0)}catch{q.notificacion("Error al crear la orden",!1)}finally{d.value=!1}}const ie=async()=>{try{const o=await V.get("ordenservicio/traer-barrios-coordenadas");console.log(o.data),H(o.data)}catch(o){return console.error("Error al cargar postes por barrio:",o),[]}};function ue(){if(y.value){b.value.setMap(null),y.value=!1;return}Z.value&&(y.value=!0,b.value=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.POLYGON,drawingControl:!1,polygonOptions:{fillColor:"#00FF00",fillOpacity:.2,strokeColor:"#00AA00",strokeWeight:2,clickable:!1,editable:!1,zIndex:1}}),b.value.setMap(u.value),google.maps.event.addListener(b.value,"overlaycomplete",function(o){const a=o.overlay;b.value.setMap(null),y.value=!1;const l=O.value.filter(s=>s&&s.getPosition&&google.maps.geometry.poly.containsLocation(s.getPosition(),a)).map(s=>s.data);ae(l),q.notificacion(`Postes seleccionados en el área: ${l}`,!0),a.setMap(null)}))}function ce(o,a=800){let e;return function(...l){clearTimeout(e),e=setTimeout(()=>o.apply(this,l),a)}}function j(){if(console.log("ejecuta"),!!u.value){h.value=!0;try{f.value.forEach(o=>{const a=o.getMap(),e=P.value?u.value:null;a!==e&&o.setMap(e)})}finally{h.value=!1}}}return ve(async()=>{const o=await q.datoUsuario();S.value=o,await R(),u.value=new google.maps.Map(document.getElementById("map"),{center:$,zoom:13,mapTypeId:"roadmap",styles:[{featureType:"poi",stylers:[{visibility:"off"}]}]}),u.value.setCenter($),u.value.setZoom(13),await ie(),I=u.value.addListener("idle",ce(()=>{h.value||(j(),z())})),await z()}),(o,a)=>(k(),N(Pe,{class:"q-pa-none"},{default:c(()=>[r("div",Ie,[a[4]||(a[4]=r("div",{id:"map",class:"map"},null,-1)),n(x,{class:"controls-panel q-pa-xs"},{default:c(()=>[r("div",ke,[r("div",xe,[n(p,{color:"primary",outline:"",label:y.value?"Cancelar":"Seleccionar área",icon:"crop_square",onClick:ue},null,8,["label"]),n(p,{color:"secondary",label:P.value?"Ocultar barrios":"Mostrar barrios",icon:"map",onClick:le},null,8,["label"]),n(p,{color:"negative",outline:"",label:"Limpiar",icon:"clear_all",onClick:A,disable:i.value.length===0},null,8,["disable"])]),r("div",Ve,[n(p,{color:"primary",label:"Continuar",icon:"arrow_forward",onClick:se,disable:i.value.length===0},null,8,["disable"])])])]),_:1}),i.value.length?(k(),N(x,{key:0,class:"selected-panel q-pa-sm"},{default:c(()=>[r("div",qe,"Seleccionados ("+T(i.value.length)+")",1),n(G,{items:i.value,style:{"max-height":"38vh"}},{default:c(({item:e})=>[r("div",Se,[r("div",Oe,T(e.Descripcion||"Poste "+(e.IdPoste||"")),1),n(p,{dense:"",flat:"",round:"",icon:"close",size:"sm",onClick:l=>oe(e)},null,8,["onClick"])]),n(fe,{inset:""})]),_:1},8,["items"])]),_:1})):me("",!0)]),n(ge,{modelValue:C.value,"onUpdate:modelValue":a[3]||(a[3]=e=>C.value=e),"full-width":"",maximized:""},{default:c(()=>[n(x,{class:"q-pa-none",style:{"max-width":"100vw",height:"100vh","border-radius":"0"}},{default:c(()=>[n(he,{class:"bg-blue-grey-9 text-white"},{default:c(()=>[n(_e,null,{default:c(()=>[...a[5]||(a[5]=[be("Ejecución de Orden",-1)])]),_:1}),W(n(p,{flat:"",round:"",dense:"",icon:"close"},null,512),[[K]])]),_:1}),r("div",Me,[r("div",Ee,[a[6]||(a[6]=r("div",{class:"text-subtitle1 q-mb-sm"},"Postes y luminarias",-1)),i.value.length?(k(),N(G,{key:1,class:"col scroll",items:i.value,separator:"",style:{"max-height":"70vh"}},{default:c(({item:e})=>[n(x,{flat:"",bordered:"",class:"q-pa-sm q-mb-sm"},{default:c(()=>[r("div",Le,T(e.Descripcion||`Poste ${e.IdPoste||""}`),1),n(D,{modelValue:w.value[e.IdPoste],"onUpdate:modelValue":l=>w.value[e.IdPoste]=l,options:ne(e),"emit-value":"","map-options":"",label:"Luminaria",dense:"",outlined:"",loading:L.value===e.IdPoste,onFocus:l=>te(e),disable:d.value},null,8,["modelValue","onUpdate:modelValue","options","loading","onFocus","disable"])]),_:2},1024)]),_:1},8,["items"])):(k(),ye("div",Be," No hay postes seleccionados. "))]),r("div",Qe,[a[7]||(a[7]=r("div",{class:"text-subtitle1 q-mb-sm"},"Detalles de la orden",-1)),n(D,{modelValue:M.value,"onUpdate:modelValue":a[0]||(a[0]=e=>M.value=e),options:X.value,"option-value":"id","option-label":"nombre",label:"Técnico (opcional)",outlined:"",dense:"","emit-value":"","map-options":"",disable:d.value},null,8,["modelValue","options","disable"]),n(D,{modelValue:E.value,"onUpdate:modelValue":a[1]||(a[1]=e=>E.value=e),options:Y.value,"option-value":"value","option-label":"label",label:"Estado",outlined:"",dense:"",class:"q-mt-sm","emit-value":"","map-options":"",disable:d.value},null,8,["modelValue","options","disable"]),n(we,{modelValue:B.value,"onUpdate:modelValue":a[2]||(a[2]=e=>B.value=e),label:"Observaciones",type:"textarea",outlined:"",dense:"",class:"q-mt-sm",autogrow:"",disable:d.value},null,8,["modelValue","disable"]),r("div",Ne,[W(n(p,{flat:"",label:"Cancelar",disable:d.value},null,8,["disable"]),[[K]]),n(p,{color:"primary",label:"Crear orden",onClick:re,loading:d.value,disable:!i.value.length||d.value},null,8,["loading","disable"])])])])]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},He=Ce(Te,[["__scopeId","data-v-d2369123"]]);export{He as default};
