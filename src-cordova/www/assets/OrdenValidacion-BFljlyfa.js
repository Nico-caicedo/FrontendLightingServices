import{r as n,c as G,o as M,k as B,l as v,m as r,f as o,Q as I,n as t,t as U,v as F,a7 as _,x as c,ao as O,p as L,a6 as m,an as N,a1 as T,y as V,ap as u}from"./index-D5vjZng5.js";import{Q as H}from"./QTd-CPa24jRu.js";import{Q as J}from"./QTable-BEUxk8-q.js";import{Q as S}from"./QMarkupTable-D_s8XBCj.js";import{Q as K,a as W}from"./QToolbar-DlwkFhaC.js";import{Q as X}from"./QTooltip-Cln5hFQH.js";import{Q as Y}from"./QFile-DR9rQXfn.js";import{Q as Z}from"./QPage-BJi1r_Vy.js";import{C as R}from"./ClosePopup-CQ1NU53x.js";import{api as w}from"./axios-CEIDL2YN.js";import{U as h}from"./Utils-Bl6bKBe-.js";import"./selection-DN5zOXK0.js";import"./format-DyQxkAtJ.js";const ee={class:"row items-center justify-between q-mb-md"},ae={key:0},oe={key:1},le={key:2},re={class:"row q-col-gutter-md"},ie={class:"text-body2 q-mb-md"},te={class:"col-6"},ne={class:"col-6"},se={class:"col-12"},de={class:"col-12"},Ie={__name:"OrdenValidacion",setup(ce){const y=n(!1),p=n(""),C=n([]),d=n({}),x=n([]),g=n(!1),Q=n(null),s=n(null),f=n(!1),i=n({Observaciones:"",Latitud:"",Longitud:"",Fotos:[],Resultado:""}),q=[{name:"Codigo",label:"Código",field:"CodigoRadicado",align:"center",sortable:!0},{name:"Fecha",label:"Fecha",field:"FechaRadicado",align:"center",format:a=>h.formatearFecha(a)},{name:"Creador",label:"Creador",field:"CreadorOrden",align:"center"},{name:"Barrio",label:"Barrio",field:"Barrio",align:"center"},{name:"NombreTecnico",label:"Asignado a",field:"NombreTecnico",align:"center"},{name:"acciones",label:"Acciones",align:"center"}],D=G(()=>{if(!p.value)return C.value;const a=p.value.toLowerCase();return C.value.filter(e=>{var l,b,A;return((l=e.CodigoRadicado)==null?void 0:l.toLowerCase().includes(a))||((b=e.Barrio)==null?void 0:b.toLowerCase().includes(a))||((A=e.AsignadoA)==null?void 0:A.toLowerCase().includes(a))})}),k=async()=>{y.value=!0;try{const a=await w.get(`/ordenservicio/${d.value.IdEmpresa}/2/traer-ordenes-empresa-visita`);C.value=a.data}catch{u.create({message:"Error al cargar órdenes",color:"negative",icon:"error"})}finally{y.value=!1}},E=async()=>{try{const a=await w.get(`usuario/2/${d.value.IdEmpresa}/usuario-por-cargo`);x.value=a.data}catch{u.create({message:"Error al cargar técnicos",color:"negative",icon:"error"})}},z=a=>{console.log(a),s.value=a,g.value=!0},P=async()=>{try{const a={IdPqrs:s.value.IdPqrs,IdUsuario:Q.value.IdUsuario,IdUsuarioA:d.value.IdUsuario};await w.post("ordenservicio/asignar-tecnicos-orden-visita",a),u.create({message:"Técnico asignado correctamente",color:"positive",icon:"check"}),g.value=!1,k()}catch{u.create({message:"Error al asignar técnico",color:"negative",icon:"error"})}},$=a=>{s.value=a,f.value=!0},j=async()=>{if(!i.value.Resultado){u.create({message:"Debe seleccionar el resultado de la validación",color:"warning",icon:"warning"});return}const a=new FormData;a.append("IdOrden",s.value.IdOrden),a.append("Observaciones",i.value.Observaciones),a.append("Latitud",i.value.Latitud),a.append("Longitud",i.value.Longitud),a.append("Resultado",i.value.Resultado);for(let e of i.value.Fotos)a.append("Fotos",e);try{await w.post("/ordenservicio/guardar-validacion",a,{headers:{"Content-Type":"multipart/form-data"}}),u.create({message:"Validación guardada correctamente",color:"positive",icon:"check"}),f.value=!1,k()}catch{u.create({message:"Error al guardar validación",color:"negative",icon:"error"})}};return M(async()=>{const a=await h.datoUsuario();d.value=a,await k(),a.IdRol==1&&await E()}),(a,e)=>(v(),B(Z,{class:"q-pa-md bg-grey-1"},{default:r(()=>[o(I,{flat:"",bordered:"",class:"q-pa-md shadow-2"},{default:r(()=>[t("div",ee,[e[8]||(e[8]=t("div",{class:"text-h6"},"Órdenes en Fase de Validación",-1)),o(U,{dense:"",debounce:"300",modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=l=>p.value=l),placeholder:"Buscar orden...",filled:"",clearable:""},{append:r(()=>[o(F,{name:"search"})]),_:1},8,["modelValue"])]),o(J,{rows:D.value,columns:q,"row-key":"IdOrden",loading:y.value,"no-data-label":"No hay órdenes para validar",flat:"",bordered:""},{"body-cell-acciones":r(l=>[o(H,{align:"center"},{default:r(()=>[d.value.IdRol==1?(v(),_("div",ae,[o(c,{color:"black",label:"Asignar Técnico",icon:"person_add",size:"sm",onClick:b=>z(l.row)},null,8,["onClick"])])):d.value.IdRol==2&&l.row.NombreTecnico==d.value.NombreCompleto?(v(),_("div",oe,[o(c,{color:"black",label:"Validar",icon:"build",size:"sm",onClick:b=>$(l.row)},null,8,["onClick"])])):(v(),_("div",le,"-"))]),_:2},1024)]),_:1},8,["rows","loading"])]),_:1}),o(O,{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=l=>g.value=l)},{default:r(()=>[o(I,{style:{"min-width":"400px"}},{default:r(()=>[o(L,{class:"text-h6"},{default:r(()=>[...e[9]||(e[9]=[m("Asignar Técnico",-1)])]),_:1}),o(L,null,{default:r(()=>[o(S,{modelValue:Q.value,"onUpdate:modelValue":e[1]||(e[1]=l=>Q.value=l),options:x.value,"option-label":"NombreCompleto","option-value":"IdUsuario",label:"Seleccione un técnico",filled:"",clearable:""},null,8,["modelValue","options"])]),_:1}),o(N,{align:"right"},{default:r(()=>[T(o(c,{flat:"",label:"Cancelar",color:"grey"},null,512),[[R]]),o(c,{label:"Asignar",color:"primary",onClick:P})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(O,{maximized:"","full-width":"",modelValue:f.value,"onUpdate:modelValue":e[7]||(e[7]=l=>f.value=l),persistent:""},{default:r(()=>[o(I,{style:{"min-width":"600px","max-width":"90vw"}},{default:r(()=>[o(K,{class:"bg-blue-grey-9 text-white"},{default:r(()=>[o(W,null,{default:r(()=>{var l;return[m(" Validar Orden - "+V((l=s.value)==null?void 0:l.CodigoRadicado),1)]}),_:1}),T((v(),B(c,{flat:"",icon:"close"},{default:r(()=>[o(X,{"content-class":"bg-white text-primary"},{default:r(()=>[...e[10]||(e[10]=[m("Cerrar",-1)])]),_:1})]),_:1})),[[R]])]),_:1}),o(L,null,{default:r(()=>[t("div",re,[t("div",ie,[e[11]||(e[11]=t("strong",null,"Barrio:",-1)),m(" "+V(s.value.Barrio||"Sin información")+" ",1),e[12]||(e[12]=t("strong",null,"Direccion:",-1)),m(" "+V(s.value.Direccion||"Sin información")+" ",1),e[13]||(e[13]=t("strong",null,"Observacion:",-1)),m(" "+V(s.value.Observacion||"No especificada"),1),e[14]||(e[14]=t("br",null,null,-1))]),e[15]||(e[15]=t("div",{class:"col-12"},null,-1)),t("div",te,[o(U,{modelValue:i.value.Latitud,"onUpdate:modelValue":e[3]||(e[3]=l=>i.value.Latitud=l),label:"Latitud",filled:""},null,8,["modelValue"])]),t("div",ne,[o(U,{modelValue:i.value.Longitud,"onUpdate:modelValue":e[4]||(e[4]=l=>i.value.Longitud=l),label:"Longitud",filled:""},null,8,["modelValue"])]),t("div",se,[o(Y,{modelValue:i.value.Fotos,"onUpdate:modelValue":e[5]||(e[5]=l=>i.value.Fotos=l),label:"Subir fotos del sitio",filled:"",multiple:"",accept:"image/*","use-chips":""},{append:r(()=>[o(F,{name:"photo_camera"})]),_:1},8,["modelValue"])]),t("div",de,[o(S,{modelValue:i.value.Resultado,"onUpdate:modelValue":e[6]||(e[6]=l=>i.value.Resultado=l),options:[{label:"Sitio verificado y correcto",value:"Aprobado"},{label:"Se requiere ajuste o corrección",value:"Rechazado"}],label:"Resultado de validación",filled:""},null,8,["modelValue"])])])]),_:1}),o(N,{align:"right"},{default:r(()=>[T(o(c,{flat:"",label:"Cancelar",color:"grey"},null,512),[[R]]),o(c,{label:"Guardar Validación",color:"positive",onClick:j})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{Ie as default};
